name: "Build and Release"

on:
  workflow_call:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        required: false
        default: "1.0.0"
        type: string
      force_release:
        description: "Force release even if no changes detected"
        required: false
        type: boolean
        default: false
  push:
    branches: [ main, develop ] 
  merge_group:
    branches: [ main ]

jobs:
  
  # Computes the release version either from user input or auto-bump
  versioning:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.setver.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      # optional: fetch tags so auto bump works
      - run: git fetch --tags

      - id: setver
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "Using manual version"
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "Computing automatic version"
            # Example automatic version computation using tags
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            BASE=${VERSION#v}

            # bump patch (example – adjust if needed)
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"
            PATCH=$((PATCH+1))
            NEW_VERSION="v$MAJOR.$MINOR.$PATCH"

            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi

  # Creates the Git tag for the version determined above
  tagging:
    runs-on: ubuntu-latest
    needs: versioning
    if: ${{ needs.versioning.outputs.version != '' }}   # <-- prevents wrong tags
    steps:
      - uses: actions/checkout@v4

      - name: Create Git tag
        uses: anothrNick/github-tag-action@1.70.0
        with:
          custom_tag: ${{ needs.versioning.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Packages the release, uploads artifacts, and publishes the GH Release
  create-release:
    runs-on: ubuntu-latest
    needs: [tagging, versioning]
    if: ${{ needs.versioning.outputs.version != '' }}

    steps:

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate and propagate release version
        run: |
          VERSION="${{ needs.versioning.outputs.version }}"

          if [ -z "$VERSION" ]; then
            echo "ERROR: No release version supplied or computed."
            exit 1
          fi

          echo "Release version: $VERSION"
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create Release Artifact ZIP
        id: zip
        run: |
          mkdir -p out release

          cp -r -t out/ theme_* META-INF/ LICENSE README.md

          ARTIFACT_FILENAME="adeptus_mechanicus_40k_theme-${{ env.RELEASE_VERSION }}.zip"
          ARTIFACT_PATH="release/$ARTIFACT_FILENAME"

          zip -j -r "$ARTIFACT_PATH" out/* && rm -r out

          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "artifact_filename=$ARTIFACT_FILENAME" >> $GITHUB_OUTPUT

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.zip.outputs.artifact_filename }}
          path: ${{ steps.zip.outputs.artifact_path }}
          retention-days: 90

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.versioning.outputs.version }}
          generate_release_notes: true
          body: |
            +++ _**INBOUND TRANSMISSION**_: CANTICLE OF THE OMNISSIAH +++
            +++ _**DESIGNATION**_: RELEASE ${{ steps.zip.outputs.artifact_filename }} +++
            +++ _**ORIGIN**_: FORGE WORLD MARS // Sectum Solar +++

            /// **SECTOR 1**: ACQUISITION VIA NOOSPHERE (JETBRAINS MARKETPLACE - *RECOMMENDED*) ///

            1. Engage **Settings/Preferences** protocols in your JetBrains Cogitator(IDE).
            2. Navigate data-paths to **Plugins** > **Marketplace**.
            3. Initiate search query for **"Adeptus Mechanicus Theme"**.
            4. Perform the **Rite of Installation**.
            5. Perform the **Prayer of Reinitialization** (Restart the IDE) when the Machine Spirit demands it.
            6. Select the sacred schema 'Mechanicus Forge World'(dark) or 'Mechanicus Sacred Data-Slate'(light) from Appearance settings.
            7. Rejoice in the blessings of the Omnissiah.

            /// **SECTOR 2**: MANUAL ENGRAM IMPLANTATION (FROM DISK) ///

            1. Download the sacred `.jar` construct.
            2. Engage **Settings/Preferences** protocols in your JetBrains Cogitator.
            3. Navigate data-paths to **Plugins**.
            4. Activate the **⚙️** icon and perform the Rite Of **"Install Plugin from Disk..."**.
            5. Select the downloaded `.jar` construct.
            6. Perform the **Prayer of Reinitialization** (Restart the IDE) when the Machine Spirit demands it
            7. Select the sacred schema 'Mechanicus Forge World'(dark) or 'Mechanicus Sacred Data-Slate'(light) from Appearance settings.
            8. Rejoice in the glory of the Omnissiah.

            May the Motive Force ensure your logic remains pure and your compilation free of heresy.

            **PRAISE THE OMNISSIAH, PRAISE THE MACHINE GOD.**
            +++ _**END OF TRANSMISSION**_ +++
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
